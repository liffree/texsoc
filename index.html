<!DOCTYPE html><html lang="en"><head><meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com; frame-src 'self' https://www.youtube.com https://trytako.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Score Keeper</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                fontFamily: {
                    sans: ['Inter', 'sans-serif'],
                },
                extend: {
                    colors: {
                        primary: '#6366F1',    // æ›´æŸ”å’Œçš„ä¸»è‰²è°ƒ
                        secondary: '#EC4899',   // æ›´ç°ä»£çš„ç²‰è‰²
                        accent: '#10B981',      // æ¸…æ–°çš„ç»¿è‰²
                        dark: '#111827',        // æ›´æ·±çš„æš—è‰²
                        light: '#F9FAFB',       // æ›´æŸ”å’Œçš„äº®è‰²
                    },
                    boxShadow: {
                        'soft': '0 2px 15px rgba(0, 0, 0, 0.05)',
                        'soft-dark': '0 2px 15px rgba(0, 0, 0, 0.2)',
                    }
                }
            }
        }
    </script>
    <style>
        /* åŸºç¡€æ ·å¼ */
        body {
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .light-theme-gradient {
            background: linear-gradient(135deg, #F9FAFB 0%, #F3F4F6 100%);
        }
        
        .dark-theme-gradient {
            background: linear-gradient(135deg, #111827 0%, #1F2937 100%);
        }
        
        /* ç°ä»£ç»ç’ƒæ‹Ÿæ€æ•ˆæœ */
        .glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.05);
        }
        
        .dark .glass {
            background: rgba(17, 24, 39, 0.7);
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 2px 15px rgba(0, 0, 0, 0.2);
        }
        
        /* ç°ä»£åŒ–å¡ç‰‡æ ·å¼ */
        .player-card {
            transition: all 0.3s ease;
            border-radius: 16px;
            overflow: hidden;
        }
        
        .player-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        
        .dark .player-card:hover {
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        
        /* ç°ä»£åŒ–æŒ‰é’®æ ·å¼ */
        .score-btn {
            transition: all 0.2s ease;
            border-radius: 12px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            background: rgba(99, 102, 241, 0.1);
            color: #6366F1;
        }
        
        .dark .score-btn {
            background: rgba(99, 102, 241, 0.2);
        }
        
        .score-btn:hover {
            background: rgba(99, 102, 241, 0.2);
        }
        
        .dark .score-btn:hover {
            background: rgba(99, 102, 241, 0.3);
        }
        
        /* åº•éƒ¨å¯¼èˆªæ ç°ä»£åŒ– */
        .bottom-bar {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 -2px 15px rgba(0, 0, 0, 0.05);
        }
        
        .dark .bottom-bar {
            background: rgba(17, 24, 39, 0.8);
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 -2px 15px rgba(0, 0, 0, 0.2);
        }
        
        /* è¾“å…¥æ¡†ç°ä»£åŒ– */
        input {
            transition: all 0.2s ease;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(99, 102, 241, 0.2);
        }
        
        .dark input {
            background: rgba(17, 24, 39, 0.8);
            border: 1px solid rgba(99, 102, 241, 0.3);
        }
        
        input:focus {
            outline: none;
            border-color: #6366F1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }
        
        /* å¼€å…³æ ·å¼ç°ä»£åŒ– */
        .switch-track {
            width: 50px;
            height: 28px;
            background-color: rgba(99, 102, 241, 0.2);
            border-radius: 14px;
            position: relative;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        
        .switch-thumb {
            width: 24px;
            height: 24px;
            border-radius: 12px;
            background-color: white;
            position: absolute;
            top: 2px;
            left: 2px;
            transition: transform 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .switched .switch-track {
            background-color: #6366F1;
        }
        
        .switched .switch-thumb {
            transform: translateX(22px);
        }

        /* æ·»åŠ æ¨¡æ€æ¡†åŸºç¡€æ ·å¼ */
        .modal-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-container.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }

        .modal-container.active .modal-content {
            transform: scale(1);
        }

        /* æ·»åŠ æç¤ºæ¶ˆæ¯æ ·å¼ */
        .toast-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 100;
        }

        .toast {
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            transform: translateX(100%);
            opacity: 0;
            transition: all 0.3s ease;
        }

        .toast.show {
            transform: translateX(0);
            opacity: 1;
        }

        .dark .toast {
            background: rgba(255, 255, 255, 0.1);
        }
    </style>
</head>
<body class="light-theme-gradient dark:dark-theme-gradient text-gray-800 dark:text-white transition-colors duration-300 min-h-screen">
    <!-- Main Container -->
    <div class="max-w-md mx-auto p-4 pb-24 relative min-h-screen">
        
        <!-- Main Scoreboard Page -->
        <div id="scoreboardPage" class="pb-20">
            <!-- Competition Title -->
            <div class="text-center mb-8 pt-6">
                <h1 id="competitionTitle" class="text-2xl font-bold flex justify-center items-center">
                    <span class="mr-3 text-4xl">ğŸ†</span>
                    <span id="titleText" class="text-glow">æ–°æ¯”èµ›</span>
                </h1>
            </div>

            <!-- Players List -->
            <div id="playerBoard" class="space-y-4"></div>
        </div>

        <!-- Settlement Page -->
        <div id="settlementPage" class="hidden pb-20">
            <div class="flex justify-between items-center mb-8 pt-4">
                <button id="backBtn" class="text-primary hover:text-opacity-80 transition-colors duration-200">
                    <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M19 12H5M12 19l-7-7 7-7"></path>
                    </svg>
                </button>
                <h2 class="text-2xl font-bold text-glow">ç»“ç®—ç»“æœ</h2>
                <div class="w-7"></div>
            </div>

            <div id="settlementResults" class="space-y-4 mb-6"></div>
            
            <div class="glass rounded-2xl p-5 mb-2">
                <h3 class="font-bold mb-3">ç»“ç®—è¯´æ˜</h3>
                <div id="settlementExplanation" class="text-sm space-y-2">
                    <p>1. æ¯æ‰‹æ¯”ä¾‹: <span id="explanationRatio" class="font-medium">10</span></p>
                    <p>2. æ¯æ‰‹ç­¹ç : <span id="explanationChips" class="font-medium">2000</span></p>
                </div>
            </div>
        </div>

        <!-- Edit Player Modal -->
        <div id="editPlayerModal" class="modal-container">
            <div class="bg-black/60 absolute inset-0 backdrop-blur-sm"></div>
            <div class="glass rounded-2xl w-full max-w-sm mx-4 overflow-hidden shadow-xl modal-content">
                <!-- Modal Header -->
                <div class="flex justify-between items-center p-6 border-b border-gray-200 dark:border-gray-700/30">
                    <h3 class="text-xl font-bold">ç¼–è¾‘ç©å®¶</h3>
                    <button id="deletePlayerBtn" class="text-red-500 hover:text-red-600 transition-colors duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M3 6h18"></path>
                            <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
                            <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
                        </svg>
                    </button>
                </div>
                
                <!-- Modal Content -->
                <div class="p-6">
                    <input type="text" id="playerNameInput" class="w-full p-4 glass rounded-xl text-base mb-6 outline-none focus:ring-2 focus:ring-primary focus:ring-opacity-50" placeholder="ç©å®¶åç§°">
                    
                    <div class="player-colors flex justify-center gap-4 mb-6">
                        <span class="w-10 h-10 rounded-full cursor-pointer transition-transform duration-200 hover:scale-110 ring-2 ring-offset-2 ring-transparent hover:ring-primary" data-color="blue-500" style="background-color: rgb(59, 130, 246);"></span>
                        <span class="w-10 h-10 rounded-full cursor-pointer transition-transform duration-200 hover:scale-110 ring-2 ring-offset-2 ring-transparent hover:ring-primary" data-color="green-500" style="background-color: rgb(34, 197, 94);"></span>
                        <span class="w-10 h-10 rounded-full cursor-pointer transition-transform duration-200 hover:scale-110 ring-2 ring-offset-2 ring-transparent hover:ring-primary" data-color="orange-500" style="background-color: rgb(249, 115, 22);"></span>
                        <span class="w-10 h-10 rounded-full cursor-pointer transition-transform duration-200 hover:scale-110 ring-2 ring-offset-2 ring-transparent hover:ring-primary" data-color="red-500" style="background-color: rgb(239, 68, 68);"></span>
                        <span class="w-10 h-10 rounded-full cursor-pointer transition-transform duration-200 hover:scale-110 ring-2 ring-offset-2 ring-transparent hover:ring-primary" data-color="purple-500" style="background-color: rgb(168, 85, 247);"></span>
                    </div>
                    
                    <div class="glass rounded-xl p-4">
                        <div class="flex justify-between items-center">
                            <span class="text-lg font-medium">å½“å‰åˆ†æ•°</span>
                            <span id="currentScore" class="font-bold text-3xl">0</span>
                        </div>
                    </div>
                </div>
                
                <!-- Modal Footer -->
                <div class="flex border-t border-gray-200 dark:border-gray-700/30">
                    <button id="closeModalBtn" class="flex-1 py-4 text-gray-500 font-medium hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors duration-200">
                        å–æ¶ˆ
                    </button>
                    <button id="savePlayerBtn" class="flex-1 py-4 text-primary font-medium hover:bg-primary/10 transition-colors duration-200">
                        ä¿å­˜
                    </button>
                </div>
            </div>
        </div>

        <!-- Settings Modal -->
        <div id="settingsModal" class="modal-container">
            <div class="bg-black bg-opacity-60 absolute inset-0 backdrop-blur-sm"></div>
            <div class="glass dark:bg-opacity-90 rounded-2xl w-full max-w-sm mx-4 overflow-hidden shadow-xl modal-content">
                <div class="flex justify-between items-center p-5 border-b border-white border-opacity-10">
                    <h3 class="text-xl font-bold">è®¾ç½®</h3>
                    <button id="closeSettingsBtn" class="text-gray-400 hover:text-gray-200 transition-colors duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                </div>
                
                <div class="p-5 space-y-5">
                    <div class="flex justify-between items-center mb-5">
                        <span>æ·±è‰²æ¨¡å¼</span>
                        <div id="darkModeToggle" class="switch-track">
                            <div class="switch-thumb"></div>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block mb-2 font-medium">æ¯”èµ›åç§°</label>
                        <input type="text" id="competitionNameInput" class="w-full p-4 glass rounded-xl text-base outline-none focus:ring-2 focus:ring-primary focus:ring-opacity-50 placeholder-gray-400 dark:placeholder-gray-500" placeholder="æ¯”èµ›åç§°">
                    </div>
                    <div>
                        <label class="block mb-2 font-medium">æ¯æ‰‹æ¯”ä¾‹</label>
                        <input type="number" id="defaultIncrementInput" class="w-full p-4 glass rounded-xl text-base outline-none focus:ring-2 focus:ring-primary focus:ring-opacity-50" value="10" min="1">
                    </div>
                    <div>
                        <label class="block mb-2 font-medium">æ¯æ‰‹ç­¹ç </label>
                        <input type="number" id="defaultInitialScoreInput" class="w-full p-4 glass rounded-xl text-base outline-none focus:ring-2 focus:ring-primary focus:ring-opacity-50" value="2000" min="1">
                    </div>
                </div>
                
                <!-- Modal Footer -->
                <div class="flex border-t border-white border-opacity-10">
                    <button id="saveSettingsBtn" class="flex-1 py-4 text-primary font-medium border-r border-white border-opacity-10 hover:bg-primary hover:bg-opacity-10 transition-colors duration-200">
                        ä¿å­˜
                    </button>
                    <button id="newGameBtn" class="flex-1 py-4 text-secondary font-medium hover:bg-secondary hover:bg-opacity-10 transition-colors duration-200">
                        æ–°æ¯”èµ›
                    </button>
                </div>
            </div>
        </div>

        <!-- Bottom Action Bar -->
        <div id="scoreboardBottomBar" class="fixed bottom-0 left-0 right-0 glass bottom-bar py-4 px-6">
            <div class="max-w-md mx-auto flex justify-between items-center">
                <div class="flex gap-3">
                    <button id="settingsBtn" class="p-3 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="3"></circle>
                            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                        </svg>
                    </button>
                    <button id="addPlayerBottomBtn" class="p-3 rounded-xl hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors duration-200">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="8.5" cy="7" r="4"></circle>
                            <line x1="20" y1="8" x2="20" y2="14"></line>
                            <line x1="23" y1="11" x2="17" y2="11"></line>
                        </svg>
                    </button>
                </div>
                <button id="settleBtn" class="bg-primary text-white px-6 py-3 rounded-xl font-medium hover:bg-primary/90 transition-colors duration-200">
                    ç»“ç®—
                </button>
            </div>
        </div>

        <!-- Bottom Action Bar for Settlement Page -->
        <div id="settlementBottomBar" class="fixed bottom-0 left-0 right-0 glass bottom-bar py-5 px-6 flex justify-end items-center hidden">
            <button id="newGameBtn2" class="glass bg-secondary px-7 py-4 rounded-xl font-medium hover:bg-opacity-95 transition-colors duration-200 glow glow-secondary">
                æ–°æ¯”èµ›
            </button>
        </div>

        <!-- Confirmation Modal -->
        <div id="confirmModal" class="modal-container">
            <div class="bg-black bg-opacity-60 absolute inset-0 backdrop-blur-sm"></div>
            <div class="glass dark:bg-opacity-90 rounded-2xl p-6 max-w-sm w-full mx-4 shadow-xl modal-content">
                <h3 class="font-bold text-xl mb-4">ç¡®è®¤</h3>
                <p class="mb-6">æ˜¯å¦ç¡®å®šå¼€å§‹æ–°æ¯”èµ›ï¼Ÿå½“å‰æ¯”èµ›æ•°æ®å°†è¢«æ¸…é™¤ã€‚</p>
                <div class="flex justify-end gap-4">
                    <button id="cancelConfirmBtn" class="px-5 py-3 glass rounded-xl hover:bg-white hover:bg-opacity-10 transition-colors duration-200">
                        å–æ¶ˆ
                    </button>
                    <button id="confirmNewGameBtn" class="px-5 py-3 glass bg-secondary rounded-xl hover:bg-opacity-95 transition-colors duration-200">
                        ç¡®å®š
                    </button>
                </div>
            </div>
        </div>

        <!-- Toast Notification -->
        <div class="toast-container"></div>
    </div>

    <script>
        // Check for dark mode preference
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // App State
        let state = {
            competitionName: "æ–°æ¯”èµ›",
            players: [],
            defaultIncrement: 10,
            defaultInitialScore: 2000,
            editingPlayerIndex: -1
        };

        // Player colors
        const playerColors = [
            "blue-500", "green-500", "orange-500", "red-500", 
            "purple-500", "indigo-500", "yellow-500", "gray-500"
        ];

        // DOM Elements
        const scoreboardPage = document.getElementById('scoreboardPage');
        const settlementPage = document.getElementById('settlementPage');
        const playerBoard = document.getElementById('playerBoard');
        const settleBtn = document.getElementById('settleBtn');
        const settingsBtn = document.getElementById('settingsBtn');
        const addPlayerBottomBtn = document.getElementById('addPlayerBottomBtn');
        const backBtn = document.getElementById('backBtn');
        const editPlayerModal = document.getElementById('editPlayerModal');
        const settingsModal = document.getElementById('settingsModal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const closeSettingsBtn = document.getElementById('closeSettingsBtn');
        const playerNameInput = document.getElementById('playerNameInput');
        const deletePlayerBtn = document.getElementById('deletePlayerBtn');
        const competitionNameInput = document.getElementById('competitionNameInput');
        const defaultIncrementInput = document.getElementById('defaultIncrementInput');
        const defaultInitialScoreInput = document.getElementById('defaultInitialScoreInput');
        const saveSettingsBtn = document.getElementById('saveSettingsBtn');
        const newGameBtn = document.getElementById('newGameBtn');
        const savePlayerBtn = document.getElementById('savePlayerBtn');
        const currentScore = document.getElementById('currentScore');
        const settlementResults = document.getElementById('settlementResults');
        const competitionTitle = document.getElementById('titleText');

        // Initialize app state
        function initState() {
            // æ£€æŸ¥æœ¬åœ°å­˜å‚¨ä¸­æ˜¯å¦æœ‰æ·±è‰²æ¨¡å¼åå¥½
            const darkModePreference = localStorage.getItem('darkMode') === 'true';
            if (darkModePreference) {
                document.documentElement.classList.add('dark');
                const darkModeToggle = document.getElementById('darkModeToggle');
                if (darkModeToggle) darkModeToggle.classList.add('switched');
            }
            
            // Initialize with default players
            for (let i = 0; i < 5; i++) {
                addPlayer(`ç”¨æˆ· ${i}`, playerColors[i % playerColors.length]);
            }
            
            renderPlayers();
            competitionTitle.textContent = state.competitionName;
            competitionNameInput.value = state.competitionName;
            defaultIncrementInput.value = state.defaultIncrement;
            defaultInitialScoreInput.value = state.defaultInitialScore;
            
            // åˆå§‹åŒ–æ¨¡æ€æ¡†
            initModals();
        }

        // åˆå§‹åŒ–æ¨¡æ€æ¡†
        function initModals() {
            // è·å–æ‰€æœ‰æ¨¡æ€æ¡†
            const modals = document.querySelectorAll('.modal-container');
            
            // ä¸ºæ¯ä¸ªæ¨¡æ€æ¡†æ·»åŠ æ˜¾ç¤ºå’Œéšè—æ–¹æ³•
            modals.forEach(modal => {
                if (!modal) return;
                
                // æ·»åŠ æ˜¾ç¤ºæ–¹æ³•
                modal.show = function() {
                    this.classList.add('active');
                    document.body.style.overflow = 'hidden'; // é˜²æ­¢èƒŒæ™¯æ»šåŠ¨
                };
                
                // æ·»åŠ éšè—æ–¹æ³•
                modal.hide = function() {
                    this.classList.remove('active');
                    document.body.style.overflow = ''; // æ¢å¤èƒŒæ™¯æ»šåŠ¨
                };

                // ç‚¹å‡»èƒŒæ™¯å…³é—­æ¨¡æ€æ¡†
                modal.addEventListener('click', (e) => {
                    if (e.target === modal || e.target.classList.contains('backdrop-blur-sm')) {
                        modal.hide();
                    }
                });
            });
            
            // ä¸ºæ·±è‰²æ¨¡å¼åˆ‡æ¢æ·»åŠ äº‹ä»¶ç›‘å¬
            const darkModeToggle = document.getElementById('darkModeToggle');
            if (darkModeToggle) {
                darkModeToggle.addEventListener('click', toggleDarkMode);
                
                // å¦‚æœå½“å‰æ˜¯æ·±è‰²æ¨¡å¼ï¼Œæ›´æ–°å¼€å…³çŠ¶æ€
                if (document.documentElement.classList.contains('dark')) {
                    darkModeToggle.classList.add('switched');
                }
            }

            // æ·»åŠ ESCé”®å…³é—­æ¨¡æ€æ¡†
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    modals.forEach(modal => {
                        if (modal.classList.contains('active')) {
                            modal.hide();
                        }
                    });
                }
            });
        }
        
        // åˆ‡æ¢æ·±è‰²æ¨¡å¼
        function toggleDarkMode() {
            const darkModeToggle = document.getElementById('darkModeToggle');
            const isDarkMode = document.documentElement.classList.toggle('dark');
            darkModeToggle.classList.toggle('switched');
            
            // ä¿å­˜åå¥½åˆ°æœ¬åœ°å­˜å‚¨
            localStorage.setItem('darkMode', isDarkMode);
        }

        // Save state (in-memory only)
        function saveState() {
            // No storage operations needed since we're using in-memory state
        }

        // Render players list
        function renderPlayers() {
            playerBoard.innerHTML = '';
            
            // ä¸ºæ¯ä¸ªç©å®¶åˆ›å»ºå¡ç‰‡
            state.players.forEach((player, index) => {
                const card = document.createElement('div');
                card.className = `player-card glass p-5 mb-4 flex flex-col gap-3`;
                
                // åˆ›å»ºç©å®¶ä¿¡æ¯åŒºåŸŸ
                const playerInfo = document.createElement('div');
                playerInfo.className = 'flex items-center justify-between';
                playerInfo.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-2 h-12 rounded-full bg-${player.color}"></div>
                        <div>
                            <div class="text-lg font-semibold">${player.name}</div>
                            <div class="text-sm text-gray-500 dark:text-gray-400">å½“å‰åˆ†æ•°</div>
                        </div>
                    </div>
                    <div class="text-2xl font-bold">${player.score}</div>
                `;
                
                // åˆ›å»ºåˆ†æ•°æ§åˆ¶åŒºåŸŸ
                const scoreControl = document.createElement('div');
                scoreControl.className = 'flex items-center justify-between mt-2';
                scoreControl.innerHTML = `
                    <button class="score-btn decrease">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                    </button>
                    <div class="flex items-center gap-2">
                        <button class="px-4 py-2 text-sm font-medium text-primary bg-primary/10 rounded-lg hover:bg-primary/20 transition-colors duration-200">
                            ç¼–è¾‘
                        </button>
                    </div>
                    <button class="score-btn increase">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <line x1="12" y1="5" x2="12" y2="19"></line>
                            <line x1="5" y1="12" x2="19" y2="12"></line>
                        </svg>
                    </button>
                `;
                
                // æ·»åŠ å­å…ƒç´ åˆ°å¡ç‰‡
                card.appendChild(playerInfo);
                card.appendChild(scoreControl);
                
                // æ·»åŠ åˆ°ç©å®¶é¢æ¿
                playerBoard.appendChild(card);
                
                // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                const decreaseBtn = scoreControl.querySelector('.decrease');
                const increaseBtn = scoreControl.querySelector('.increase');
                const editBtn = scoreControl.querySelector('button:not(.score-btn)');
                
                decreaseBtn.addEventListener('click', () => {
                    player.score = Math.max(0, player.score - 1);
                    playerInfo.querySelector('.text-2xl').textContent = player.score;
                    saveState();
                });
                
                increaseBtn.addEventListener('click', () => {
                    player.score++;
                    playerInfo.querySelector('.text-2xl').textContent = player.score;
                    saveState();
                });
                
                editBtn.addEventListener('click', () => {
                    openEditPlayerModal(index);
                });
            });
            
            // æ·»åŠ "æ·»åŠ ç©å®¶"å¡ç‰‡
            const addCard = document.createElement('div');
            addCard.className = `player-card glass p-5 flex items-center justify-center gap-2 cursor-pointer hover:bg-primary/5 transition-colors duration-200`;
            addCard.innerHTML = `
                <span class="text-lg font-medium text-gray-500 dark:text-gray-400">æ·»åŠ ç©å®¶</span>
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
            `;
            
            addCard.addEventListener('click', () => {
                addPlayer();
            });
            
            playerBoard.appendChild(addCard);
        }

        // Add a new player
        function addPlayer(name = `ç”¨æˆ· ${state.players.length}`, color = playerColors[state.players.length % playerColors.length]) {
            try {
                if (state.players.length >= 8) {
                    showToast('æœ€å¤šåªèƒ½æ·»åŠ 8åç©å®¶');
                    return;
                }

                state.players.push({
                    name: name,
                    color: color,
                    score: 1,
                    increment: state.defaultIncrement,
                    initialScore: state.defaultInitialScore
                });
                
                saveState();
                renderPlayers();
                showToast('æ·»åŠ ç©å®¶æˆåŠŸ');
            } catch (error) {
                console.error('æ·»åŠ ç©å®¶æ—¶å‡ºé”™:', error);
                showToast('æ·»åŠ ç©å®¶å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // Open edit player modal
        function openEditPlayerModal(playerIndex) {
            const editPlayerModal = document.getElementById('editPlayerModal');
            if (!editPlayerModal) return;

            state.editingPlayerIndex = playerIndex;
            const player = state.players[playerIndex];
            
            const playerNameInput = document.getElementById('playerNameInput');
            const currentScore = document.getElementById('currentScore');
            
            if (playerNameInput) playerNameInput.value = player.name;
            if (currentScore) currentScore.textContent = player.score;
            
            // é«˜äº®é€‰æ‹©çš„é¢œè‰²
            const colorElements = document.querySelectorAll('.player-colors span');
            colorElements.forEach(el => {
                el.classList.remove('selected');
                if (el.dataset.color === player.color) {
                    el.classList.add('selected');
                }
            });
            
            editPlayerModal.show();
        }

        // Render settlement results
        function renderSettlementResults() {
            settlementResults.innerHTML = '';
            
            // Sort players by score (highest first)
            const sortedPlayers = [...state.players].sort((a, b) => b.score - a.score);
            
            // Keep track of total values for the summary card
            let allTotalValues = [];
            
            sortedPlayers.forEach((player, index) => {
                const playerResult = document.createElement('div');
                playerResult.className = `glass bg-${player.color} bg-opacity-20 rounded-xl p-4 mb-3 slide-in`;
                playerResult.style.animationDelay = `${index * 0.05}s`;
                
                // Create the top part with name and score
                const topRow = document.createElement('div');
                topRow.className = 'flex items-center justify-between mb-3';
                topRow.innerHTML = `
                    <div class="flex items-center">
                        <span class="font-medium mr-2">${index + 1}.</span>
                        <span class="font-medium">${player.name}</span>
                    </div>
                    <div class="font-bold text-2xl">${player.score}</div>
                `;
                playerResult.appendChild(topRow);
                
                // Create the balance input row
                const balanceRow = document.createElement('div');
                balanceRow.className = 'flex items-center justify-between mb-2';
                balanceRow.innerHTML = `
                    <label class="text-sm">ç»“ä½™ï¼š</label>
                    <input type="number" class="balance-input w-24 p-2 glass rounded-lg text-right text-base outline-none focus:ring-1 focus:ring-primary focus:ring-opacity-50" value="0">
                `;
                playerResult.appendChild(balanceRow);
                
                // Create the total row
                const totalRow = document.createElement('div');
                totalRow.className = 'flex items-center justify-between';
                totalRow.innerHTML = `
                    <span class="text-sm">æ€»è®¡ï¼š</span>
                    <span class="total-value font-medium">0</span>
                `;
                playerResult.appendChild(totalRow);
                
                settlementResults.appendChild(playerResult);
                
                // Add event listener to update calculation when balance input changes
                const balanceInput = balanceRow.querySelector('.balance-input');
                const totalValue = totalRow.querySelector('.total-value');
                
                // Calculate the initial value
                const initialValue = updateTotalValue(balanceInput, totalValue, player.score);
                allTotalValues.push({ value: initialValue, element: totalValue });
                
                // Add event listener for changes
                balanceInput.addEventListener('input', () => {
                    const newValue = updateTotalValue(balanceInput, totalValue, player.score);
                    // Update the corresponding value in our tracking array
                    const index = allTotalValues.findIndex(item => item.element === totalValue);
                    if (index !== -1) {
                        allTotalValues[index].value = newValue;
                        updateSummaryCard();
                    }
                });
            });
            
            // Add summary card
            const summaryCard = document.createElement('div');
            summaryCard.className = 'glass rounded-xl p-4 mb-3 slide-in';
            summaryCard.style.animationDelay = `${sortedPlayers.length * 0.05}s`;
            summaryCard.innerHTML = `
                <div class="flex justify-between items-center">
                    <span class="font-medium">ç»Ÿè®¡</span>
                    <span id="totalSum" class="font-bold text-xl">0.00</span>
                </div>
            `;
            settlementResults.appendChild(summaryCard);
            
            // Function to update the summary card with total sum
            function updateSummaryCard() {
                const totalSum = allTotalValues.reduce((sum, item) => sum + item.value, 0);
                document.getElementById('totalSum').textContent = totalSum.toFixed(2);
            }
            
            // Initial update
            updateSummaryCard();
        }
        
        // Helper function to update total value based on balance input
        function updateTotalValue(inputElement, totalElement, playerScore) {
            const balanceValue = parseFloat(inputElement.value) || 0;
            const perHandChips = state.defaultInitialScore; // z
            const perHandRatio = state.defaultIncrement;    // y
            
            // Calculate a = (b-(x*z))/y
            const calculatedValue = (balanceValue - (playerScore * perHandChips)) / perHandRatio;
            
            // Format the result to 2 decimal places
            totalElement.textContent = calculatedValue.toFixed(2);
            
            // Return the calculated value for tracking
            return calculatedValue;
        }

        // Event Listeners
        // DOM Elements for new bottom bars and confirm modal
        const scoreboardBottomBar = document.getElementById('scoreboardBottomBar');
        const settlementBottomBar = document.getElementById('settlementBottomBar');
        const newGameBtn2 = document.getElementById('newGameBtn2');
        const confirmModal = document.getElementById('confirmModal');
        const cancelConfirmBtn = document.getElementById('cancelConfirmBtn');
        const confirmNewGameBtn = document.getElementById('confirmNewGameBtn');

        // Show settlement page
        settleBtn.addEventListener('click', () => {
            try {
                if (state.players.length < 2) {
                    showToast('è‡³å°‘éœ€è¦2åç©å®¶æ‰èƒ½ç»“ç®—');
                    return;
                }

                renderSettlementResults();
                
                scoreboardPage.classList.add('hidden');
                settlementPage.classList.remove('hidden');
                settlementPage.classList.add('fade-in');
                
                scoreboardBottomBar.classList.add('hidden');
                settlementBottomBar.classList.remove('hidden');
                
                document.getElementById('explanationRatio').textContent = state.defaultIncrement;
                document.getElementById('explanationChips').textContent = state.defaultInitialScore;
            } catch (error) {
                console.error('ç»“ç®—æ—¶å‡ºé”™:', error);
                showToast('ç»“ç®—å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        });

        // Go back to scoreboard page
        backBtn.addEventListener('click', () => {
            scoreboardPage.classList.remove('hidden');
            scoreboardPage.classList.add('fade-in');
            settlementPage.classList.add('hidden');
            
            // åˆ‡æ¢åº•éƒ¨æ 
            settlementBottomBar.classList.add('hidden');
            scoreboardBottomBar.classList.remove('hidden');
        });
        
        // New game button in settlement page
        newGameBtn2.addEventListener('click', () => {
            confirmModal.show();
        });
        
        // Cancel confirmation
        cancelConfirmBtn.addEventListener('click', () => {
            confirmModal.hide();
        });
        
        // Confirm new game
        confirmNewGameBtn.addEventListener('click', () => {
            // Reset the game
            state.players = [];
            state.competitionName = "æ–°æ¯”èµ›";
            state.defaultIncrement = 10;
            state.defaultInitialScore = 2000;
            
            // Reinitialize the app
            initState();
            
            // Hide modals and go back to scoreboard
            confirmModal.hide();
            settlementPage.classList.add('hidden');
            scoreboardPage.classList.remove('hidden');
            
            // Switch bottom bars
            settlementBottomBar.classList.add('hidden');
            scoreboardBottomBar.classList.remove('hidden');
        });
        
        // Click background to close confirm modal
        confirmModal.addEventListener('click', (e) => {
            if (e.target === confirmModal || e.target.classList.contains('backdrop-blur-sm')) {
                confirmModal.hide();
            }
        });

        addPlayerBottomBtn.addEventListener('click', () => {
            addPlayer();
        });

        settingsBtn.addEventListener('click', () => {
            settingsModal.show();
        });

        closeSettingsBtn.addEventListener('click', () => {
            settingsModal.hide();
        });

        closeModalBtn.addEventListener('click', () => {
            editPlayerModal.hide();
        });

        deletePlayerBtn.addEventListener('click', () => {
            if (state.editingPlayerIndex < 0) {
                showToast('åˆ é™¤å¤±è´¥ï¼šæ— æ•ˆçš„ç©å®¶æ•°æ®');
                return;
            }

            try {
                const player = state.players[state.editingPlayerIndex];
                if (confirm(`ç¡®å®šè¦åˆ é™¤ç©å®¶ "${player.name}" å—ï¼Ÿ`)) {
                    state.players.splice(state.editingPlayerIndex, 1);
                    saveState();
                    renderPlayers();
                    document.getElementById('editPlayerModal').hide();
                    showToast('åˆ é™¤æˆåŠŸ');
                }
            } catch (error) {
                console.error('åˆ é™¤ç©å®¶æ—¶å‡ºé”™:', error);
                showToast('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        });

        // Save settings button
        saveSettingsBtn.addEventListener('click', () => {
            state.competitionName = competitionNameInput.value || "æ–°æ¯”èµ›";
            state.defaultIncrement = parseInt(defaultIncrementInput.value) || 10;
            state.defaultInitialScore = parseInt(defaultInitialScoreInput.value) || 2000;
            
            competitionTitle.textContent = state.competitionName;
            saveState();
            settingsModal.hide();
        });
        
        // New game button
        newGameBtn.addEventListener('click', () => {
            confirmModal.show();
        });

        // Handle color selection in edit modal
        document.querySelectorAll('.player-colors span').forEach(colorEl => {
            colorEl.addEventListener('click', () => {
                document.querySelectorAll('.player-colors span').forEach(el => {
                    el.classList.remove('selected');
                });
                colorEl.classList.add('selected');
            });
        });

        // Save player changes
        document.getElementById('playerNameInput').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                savePlayerChanges();
            }
        });

        function savePlayerChanges() {
            const editPlayerModal = document.getElementById('editPlayerModal');
            if (!editPlayerModal || state.editingPlayerIndex < 0) {
                showToast('ä¿å­˜å¤±è´¥ï¼šæ— æ•ˆçš„ç©å®¶æ•°æ®');
                return;
            }

            const player = state.players[state.editingPlayerIndex];
            const playerNameInput = document.getElementById('playerNameInput');
            
            try {
                // æ›´æ–°ç©å®¶åç§°
                if (playerNameInput) {
                    const newName = playerNameInput.value.trim();
                    if (!newName) {
                        showToast('è¯·è¾“å…¥ç©å®¶åç§°');
                        playerNameInput.focus();
                        return;
                    }
                    player.name = newName;
                }
                
                // æ›´æ–°é¢œè‰²
                const selectedColor = document.querySelector('.player-colors span.selected');
                if (!selectedColor) {
                    showToast('è¯·é€‰æ‹©ç©å®¶é¢œè‰²');
                    return;
                }
                player.color = selectedColor.dataset.color;
                
                saveState();
                renderPlayers();
                editPlayerModal.hide();
                showToast('ä¿å­˜æˆåŠŸ');
            } catch (error) {
                console.error('ä¿å­˜ç©å®¶æ•°æ®æ—¶å‡ºé”™:', error);
                showToast('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }
        
        // Add save button event listener
        savePlayerBtn.addEventListener('click', savePlayerChanges);
        
        // Handle settings form submission
        competitionNameInput.addEventListener('change', () => {
            state.competitionName = competitionNameInput.value;
            competitionTitle.textContent = state.competitionName;
            saveState();
        });

        defaultIncrementInput.addEventListener('change', () => {
            state.defaultIncrement = parseInt(defaultIncrementInput.value) || 10;
            saveState();
        });

        defaultInitialScoreInput.addEventListener('change', () => {
            state.defaultInitialScore = parseInt(defaultInitialScoreInput.value) || 2000;
            saveState();
        });

        // Initialize the app
        document.addEventListener('DOMContentLoaded', () => {
            initState();
            initModals();
        });

        // æ·»åŠ æç¤ºæ¶ˆæ¯åŠŸèƒ½
        function showToast(message, type = 'info') {
            const toastContainer = document.querySelector('.toast-container');
            if (!toastContainer) return;

            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;

            toastContainer.appendChild(toast);

            // è§¦å‘é‡æ’ä»¥å¯åŠ¨åŠ¨ç”»
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);

            // 3ç§’åç§»é™¤æç¤º
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    toastContainer.removeChild(toast);
                }, 300);
            }, 3000);
        }
    </script>
</body></html>
